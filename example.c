/* example.c
 * one simple example that illustrates how to integrate lib-RLC into your code.
 */
#include <stdlib.h>
#include <string.h>
#include <stdio.h>
#include <assert.h>
#include <time.h>


#include "rlc.h"
#include "log.h"

/* structure and definitions: could be moved to a .h file */
#define MAC_DL_LCID_CCCH    0x00			//CCCH
#define MAC_DL_LCID_UCRI    0x1C			//UE Contention Resolution Identity
#define MAC_DL_LCID_TA      0x1D			//Timing Advance Command
#define MAC_DL_LCID_DRX     0x1E			//DRX Command
#define MAC_DL_LCID_PADDING 0x1F			//Padding

#define MAC_UL_LCID_CCCH    0x00			//CCCH
#define MAC_UL_LCID_PHR     0x1A			//Power Headroom Report
#define MAC_UL_LCID_CRNTI   0x1B			//C-RNTI
#define MAC_UL_LCID_TBSR    0x1C			//Truncated BSR
#define MAC_UL_LCID_SBSR    0x1D			//Short BSR
#define MAC_UL_LCID_LBSR    0x1E			//Long BSR
#define MAC_UL_LCID_PADDING 0x1F			//Padding

#define MAC_LCID_MAX 0x0A+1

#pragma pack(1)

typedef struct mac_pdu_subhead
{
	u32 r:2;
	u32 e:1;
	u32 lc_id:5;
	u32 f:1;
	u32 l:15;
}mac_pdu_subhead_t;

#pragma pack()

/* TBS table defined in 36.213 */
#define NB_PRB 110
#define MAC_TBS_MAX_SIZE (75376/8)
#define MAC_TBS_MIN_SIZE 4
static int mac_tbs_table[] =
{
16, 32, 56, 88, 120, 152, 176, 208, 224, 256, 288, 328, 344, 376, 392, 424, 456, 488, 504, 536, 568, 600, 616, 648, 680, 712, 744, 776, 776, 808, 840, 872, 904, 936, 968, 1000, 1032, 1032, 1064, 1096, 1128, 1160, 1192, 1224, 1256, 1256, 1288, 1320, 1352, 1384, 1416, 1416, 1480, 1480, 1544, 1544, 1608, 1608, 1608, 1672, 1672, 1736, 1736, 1800, 1800, 1800, 1864, 1864, 1928, 1928, 1992, 1992, 2024, 2088, 2088, 2088, 2152, 2152, 2216, 2216, 2280, 2280, 2280, 2344, 2344, 2408, 2408, 2472, 2472, 2536, 2536, 2536, 2600, 2600, 2664, 2664, 2728, 2728, 2728, 2792, 2792, 2856, 2856, 2856, 2984, 2984, 2984, 2984, 2984, 3112, 
24, 56, 88, 144, 176, 208, 224, 256, 328, 344, 376, 424, 456, 488, 520, 568, 600, 632, 680, 712, 744, 776, 808, 872, 904, 936, 968, 1000, 1032, 1064, 1128, 1160, 1192, 1224, 1256, 1288, 1352, 1384, 1416, 1416, 1480, 1544, 1544, 1608, 1608, 1672, 1736, 1736, 1800, 1800, 1864, 1864, 1928, 1992, 1992, 2024, 2088, 2088, 2152, 2152, 2216, 2280, 2280, 2344, 2344, 2408, 2472, 2472, 2536, 2536, 2600, 2600, 2664, 2728, 2728, 2792, 2792, 2856, 2856, 2856, 2984, 2984, 2984, 3112, 3112, 3112, 3240, 3240, 3240, 3240, 3368, 3368, 3368, 3496, 3496, 3496, 3496, 3624, 3624, 3624, 3752, 3752, 3752, 3752, 3880, 3880, 3880, 4008, 4008, 4008, 
32, 72, 144, 176, 208, 256, 296, 328, 376, 424, 472, 520, 568, 616, 648, 696, 744, 776, 840, 872, 936, 968, 1000, 1064, 1096, 1160, 1192, 1256, 1288, 1320, 1384, 1416, 1480, 1544, 1544, 1608, 1672, 1672, 1736, 1800, 1800, 1864, 1928, 1992, 2024, 2088, 2088, 2152, 2216, 2216, 2280, 2344, 2344, 2408, 2472, 2536, 2536, 2600, 2664, 2664, 2728, 2792, 2856, 2856, 2856, 2984, 2984, 3112, 3112, 3112, 3240, 3240, 3240, 3368, 3368, 3368, 3496, 3496, 3496, 3624, 3624, 3624, 3752, 3752, 3880, 3880, 3880, 4008, 4008, 4008, 4136, 4136, 4136, 4264, 4264, 4264, 4392, 4392, 4392, 4584, 4584, 4584, 4584, 4584, 4776, 4776, 4776, 4776, 4968, 4968, 
40, 104, 176, 208, 256, 328, 392, 440, 504, 568, 616, 680, 744, 808, 872, 904, 968, 1032, 1096, 1160, 1224, 1256, 1320, 1384, 1416, 1480, 1544, 1608, 1672, 1736, 1800, 1864, 1928, 1992, 2024, 2088, 2152, 2216, 2280, 2344, 2408, 2472, 2536, 2536, 2600, 2664, 2728, 2792, 2856, 2856, 2984, 2984, 3112, 3112, 3240, 3240, 3368, 3368, 3496, 3496, 3624, 3624, 3624, 3752, 3752, 3880, 3880, 4008, 4008, 4136, 4136, 4264, 4264, 4392, 4392, 4392, 4584, 4584, 4584, 4776, 4776, 4776, 4776, 4968, 4968, 4968, 5160, 5160, 5160, 5352, 5352, 5352, 5352, 5544, 5544, 5544, 5736, 5736, 5736, 5736, 5992, 5992, 5992, 5992, 6200, 6200, 6200, 6200, 6456, 6456, 
56, 120, 208, 256, 328, 408, 488, 552, 632, 696, 776, 840, 904, 1000, 1064, 1128, 1192, 1288, 1352, 1416, 1480, 1544, 1608, 1736, 1800, 1864, 1928, 1992, 2088, 2152, 2216, 2280, 2344, 2408, 2472, 2600, 2664, 2728, 2792, 2856, 2984, 2984, 3112, 3112, 3240, 3240, 3368, 3496, 3496, 3624, 3624, 3752, 3752, 3880, 4008, 4008, 4136, 4136, 4264, 4264, 4392, 4392, 4584, 4584, 4584, 4776, 4776, 4968, 4968, 4968, 5160, 5160, 5160, 5352, 5352, 5544, 5544, 5544, 5736, 5736, 5736, 5992, 5992, 5992, 5992, 6200, 6200, 6200, 6456, 6456, 6456, 6456, 6712, 6712, 6712, 6968, 6968, 6968, 6968, 7224, 7224, 7224, 7480, 7480, 7480, 7480, 7736, 7736, 7736, 7992, 
72, 144, 224, 328, 424, 504, 600, 680, 776, 872, 968, 1032, 1128, 1224, 1320, 1384, 1480, 1544, 1672, 1736, 1864, 1928, 2024, 2088, 2216, 2280, 2344, 2472, 2536, 2664, 2728, 2792, 2856, 2984, 3112, 3112, 3240, 3368, 3496, 3496, 3624, 3752, 3752, 3880, 4008, 4008, 4136, 4264, 4392, 4392, 4584, 4584, 4776, 4776, 4776, 4968, 4968, 5160, 5160, 5352, 5352, 5544, 5544, 5736, 5736, 5736, 5992, 5992, 5992, 6200, 6200, 6200, 6456, 6456, 6712, 6712, 6712, 6968, 6968, 6968, 7224, 7224, 7224, 7480, 7480, 7480, 7736, 7736, 7736, 7992, 7992, 7992, 8248, 8248, 8248, 8504, 8504, 8760, 8760, 8760, 8760, 9144, 9144, 9144, 9144, 9528, 9528, 9528, 9528, 9528, 
328, 176, 256, 392, 504, 600, 712, 808, 936, 1032, 1128, 1224, 1352, 1480, 1544, 1672, 1736, 1864, 1992, 2088, 2216, 2280, 2408, 2472, 2600, 2728, 2792, 2984, 2984, 3112, 3240, 3368, 3496, 3496, 3624, 3752, 3880, 4008, 4136, 4136, 4264, 4392, 4584, 4584, 4776, 4776, 4968, 4968, 5160, 5160, 5352, 5352, 5544, 5736, 5736, 5992, 5992, 5992, 6200, 6200, 6456, 6456, 6456, 6712, 6712, 6968, 6968, 6968, 7224, 7224, 7480, 7480, 7736, 7736, 7736, 7992, 7992, 8248, 8248, 8248, 8504, 8504, 8760, 8760, 8760, 9144, 9144, 9144, 9144, 9528, 9528, 9528, 9528, 9912, 9912, 9912, 10296, 10296, 10296, 10296, 10680, 10680, 10680, 10680, 11064, 11064, 11064, 11448, 11448, 11448, 
104, 224, 328, 472, 584, 712, 840, 968, 1096, 1224, 1320, 1480, 1608, 1672, 1800, 1928, 2088, 2216, 2344, 2472, 2536, 2664, 2792, 2984, 3112, 3240, 3368, 3368, 3496, 3624, 3752, 3880, 4008, 4136, 4264, 4392, 4584, 4584, 4776, 4968, 4968, 5160, 5352, 5352, 5544, 5736, 5736, 5992, 5992, 6200, 6200, 6456, 6456, 6712, 6712, 6712, 6968, 6968, 7224, 7224, 7480, 7480, 7736, 7736, 7992, 7992, 8248, 8248, 8504, 8504, 8760, 8760, 8760, 9144, 9144, 9144, 9528, 9528, 9528, 9912, 9912, 9912, 10296, 10296, 10296, 10680, 10680, 10680, 11064, 11064, 11064, 11448, 11448, 11448, 11448, 11832, 11832, 11832, 12216, 12216, 12216, 12576, 12576, 12576, 12960, 12960, 12960, 12960, 13536, 13536,
120, 256, 392, 536, 680, 808, 968, 1096, 1256, 1384, 1544, 1672, 1800, 1928, 2088, 2216, 2344, 2536, 2664, 2792, 2984, 3112, 3240, 3368, 3496, 3624, 3752, 3880, 4008, 4264, 4392, 4584, 4584, 4776, 4968, 4968, 5160, 5352, 5544, 5544, 5736, 5992, 5992, 6200, 6200, 6456, 6456, 6712, 6968, 6968, 7224, 7224, 7480, 7480, 7736, 7736, 7992, 7992, 8248, 8504, 8504, 8760, 8760, 9144, 9144, 9144, 9528, 9528, 9528, 9912, 9912, 9912, 10296, 10296, 10680, 10680, 10680, 11064, 11064, 11064, 11448, 11448, 11448, 11832, 11832, 12216, 12216, 12216, 12576, 12576, 12576, 12960, 12960, 12960, 13536, 13536, 13536, 13536, 14112, 14112, 14112, 14112, 14688, 14688, 14688, 14688, 15264, 15264, 15264, 15264, 
136, 296, 456, 616, 776, 936, 1096, 1256, 1416, 1544, 1736, 1864, 2024, 2216, 2344, 2536, 2664, 2856, 2984, 3112, 3368, 3496, 3624, 3752, 4008, 4136, 4264, 4392, 4584, 4776, 4968, 5160, 5160, 5352, 5544, 5736, 5736, 5992, 6200, 6200, 6456, 6712, 6712, 6968, 6968, 7224, 7480, 7480, 7736, 7992, 7992, 8248, 8248, 8504, 8760, 8760, 9144, 9144, 9144, 9528, 9528, 9912, 9912, 10296, 10296, 10296, 10680, 10680, 11064, 11064, 11064, 11448, 11448, 11832, 11832, 11832, 12216, 12216, 12576, 12576, 12960, 12960, 12960, 13536, 13536, 13536, 13536, 14112, 14112, 14112, 14112, 14688, 14688, 14688, 15264, 15264, 15264, 15264, 15840, 15840, 15840, 16416, 16416, 16416, 16416, 16992, 16992, 16992, 16992, 17568, 
144, 328, 504, 680, 872, 1032, 1224, 1384, 1544, 1736, 1928, 2088, 2280, 2472, 2664, 2792, 2984, 3112, 3368, 3496, 3752, 3880, 4008, 4264, 4392, 4584, 4776, 4968, 5160, 5352, 5544, 5736, 5736, 5992, 6200, 6200, 6456, 6712, 6712, 6968, 7224, 7480, 7480, 7736, 7992, 7992, 8248, 8504, 8504, 8760, 9144, 9144, 9144, 9528, 9528, 9912, 9912, 10296, 10296, 10680, 10680, 11064, 11064, 11448, 11448, 11448, 11832, 11832, 12216, 12216, 12576, 12576, 12960, 12960, 12960, 13536, 13536, 13536, 14112, 14112, 14112, 14688, 14688, 14688, 14688, 15264, 15264, 15264, 15840, 15840, 15840, 16416, 16416, 16416, 16992, 16992, 16992, 16992, 17568, 17568, 17568, 18336, 18336, 18336, 18336, 18336, 19080, 19080, 19080, 19080, 
176, 376, 584, 776, 1000, 1192, 1384, 1608, 1800, 2024, 2216, 2408, 2600, 2792, 2984, 3240, 3496, 3624, 3880, 4008, 4264, 4392, 4584, 4776, 4968, 5352, 5544, 5736, 5992, 5992, 6200, 6456, 6712, 6968, 6968, 7224, 7480, 7736, 7736, 7992, 8248, 8504, 8760, 8760, 9144, 9144, 9528, 9528, 9912, 9912, 10296, 10680, 10680, 11064, 11064, 11448, 11448, 11832, 11832, 12216, 12216, 12576, 12576, 12960, 12960, 13536, 13536, 13536, 14112, 14112, 14112, 14688, 14688, 14688, 15264, 15264, 15840, 15840, 15840, 16416, 16416, 16416, 16992, 16992, 16992, 17568, 17568, 17568, 18336, 18336, 18336, 18336, 19080, 19080, 19080, 19080, 19848, 19848, 19848, 19848, 20616, 20616, 20616, 21384, 21384, 21384, 21384, 22152, 22152, 22152, 
208, 440, 680, 904, 1128, 1352, 1608, 1800, 2024, 2280, 2472, 2728, 2984, 3240, 3368, 3624, 3880, 4136, 4392, 4584, 4776, 4968, 5352, 5544, 5736, 5992, 6200, 6456, 6712, 6712, 6968, 7224, 7480, 7736, 7992, 8248, 8504, 8760, 8760, 9144, 9528, 9528, 9912, 9912, 10296, 10680, 10680, 11064, 11064, 11448, 11832, 11832, 12216, 12216, 12576, 12576, 12960, 12960, 13536, 13536, 14112, 14112, 14112, 14688, 14688, 15264, 15264, 15264, 15840, 15840, 16416, 16416, 16416, 16992, 16992, 17568, 17568, 17568, 18336, 18336, 18336, 19080, 19080, 19080, 19080, 19848, 19848, 19848, 20616, 20616, 20616, 21384, 21384, 21384, 21384, 22152, 22152, 22152, 22920, 22920, 22920, 23688, 23688, 23688, 23688, 24496, 24496, 24496, 24496, 25456, 
224, 488, 744, 1000, 1256, 1544, 1800, 2024, 2280, 2536, 2856, 3112, 3368, 3624, 3880, 4136, 4392, 4584, 4968, 5160, 5352, 5736, 5992, 6200, 6456, 6712, 6968, 7224, 7480, 7736, 7992, 8248, 8504, 8760, 9144, 9144, 9528, 9912, 9912, 10296, 10680, 10680, 11064, 11448, 11448, 11832, 12216, 12216, 12576, 12960, 12960, 13536, 13536, 14112, 14112, 14688, 14688, 14688, 15264, 15264, 15840, 15840, 16416, 16416, 16992, 16992, 16992, 17568, 17568, 18336, 18336, 18336, 19080, 19080, 19080, 19848, 19848, 19848, 20616, 20616, 20616, 21384, 21384, 21384, 22152, 22152, 22152, 22920, 22920, 22920, 23688, 23688, 23688, 24496, 24496, 24496, 25456, 25456, 25456, 25456, 26416, 26416, 26416, 26416, 27376, 27376, 27376, 27376, 28336, 28336, 
256, 552, 840, 1128, 1416, 1736, 1992, 2280, 2600, 2856, 3112, 3496, 3752, 4008, 4264, 4584, 4968, 5160, 5544, 5736, 5992, 6200, 6456, 6968, 7224, 7480, 7736, 7992, 8248, 8504, 8760, 9144, 9528, 9912, 9912, 10296, 10680, 11064, 11064, 11448, 11832, 12216, 12216, 12576, 12960, 12960, 13536, 13536, 14112, 14112, 14688, 14688, 15264, 15264, 15840, 15840, 16416, 16416, 16992, 16992, 17568, 17568, 18336, 18336, 18336, 19080, 19080, 19848, 19848, 19848, 20616, 20616, 20616, 21384, 21384, 22152, 22152, 22152, 22920, 22920, 22920, 23688, 23688, 24496, 24496, 24496, 25456, 25456, 25456, 25456, 26416, 26416, 26416, 27376, 27376, 27376, 28336, 28336, 28336, 28336, 29296, 29296, 29296, 29296, 30576, 30576, 30576, 30576, 31704, 31704, 
280, 600, 904, 1224, 1544, 1800, 2152, 2472, 2728, 3112, 3368, 3624, 4008, 4264, 4584, 4968, 5160, 5544, 5736, 6200, 6456, 6712, 6968, 7224, 7736, 7992, 8248, 8504, 8760, 9144, 9528, 9912, 10296, 10296, 10680, 11064, 11448, 11832, 11832, 12216, 12576, 12960, 12960, 13536, 13536, 14112, 14688, 14688, 15264, 15264, 15840, 15840, 16416, 16416, 16992, 16992, 17568, 17568, 18336, 18336, 18336, 19080, 19080, 19848, 19848, 20616, 20616, 20616, 21384, 21384, 22152, 22152, 22152, 22920, 22920, 23688, 23688, 23688, 24496, 24496, 24496, 25456, 25456, 25456, 26416, 26416, 26416, 27376, 27376, 27376, 28336, 28336, 28336, 29296, 29296, 29296, 29296, 30576, 30576, 30576, 30576, 31704, 31704, 31704, 31704, 32856, 32856, 32856, 34008, 34008, 
328, 632, 968, 1288, 1608, 1928, 2280, 2600, 2984, 3240, 3624, 3880, 4264, 4584, 4968, 5160, 5544, 5992, 6200, 6456, 6712, 7224, 7480, 7736, 7992, 8504, 8760, 9144, 9528, 9912, 9912, 10296, 10680, 11064, 11448, 11832, 12216, 12216, 12576, 12960, 13536, 13536, 14112, 14112, 14688, 14688, 15264, 15840, 15840, 16416, 16416, 16992, 16992, 17568, 17568, 18336, 18336, 19080, 19080, 19848, 19848, 19848, 20616, 20616, 21384, 21384, 22152, 22152, 22152, 22920, 22920, 23688, 23688, 24496, 24496, 24496, 25456, 25456, 25456, 26416, 26416, 26416, 27376, 27376, 27376, 28336, 28336, 28336, 29296, 29296, 29296, 30576, 30576, 30576, 30576, 31704, 31704, 31704, 31704, 32856, 32856, 32856, 34008, 34008, 34008, 34008, 35160, 35160, 35160, 35160, 
336, 696, 1064, 1416, 1800, 2152, 2536, 2856, 3240, 3624, 4008, 4392, 4776, 5160, 5352, 5736, 6200, 6456, 6712, 7224, 7480, 7992, 8248, 8760, 9144, 9528, 9912, 10296, 10296, 10680, 11064, 11448, 11832, 12216, 12576, 12960, 13536, 13536, 14112, 14688, 14688, 15264, 15264, 15840, 16416, 16416, 16992, 17568, 17568, 18336, 18336, 19080, 19080, 19848, 19848, 20616, 20616, 20616, 21384, 21384, 22152, 22152, 22920, 22920, 23688, 23688, 24496, 24496, 24496, 25456, 25456, 26416, 26416, 26416, 27376, 27376, 27376, 28336, 28336, 29296, 29296, 29296, 30576, 30576, 30576, 30576, 31704, 31704, 31704, 32856, 32856, 32856, 34008, 34008, 34008, 35160, 35160, 35160, 35160, 36696, 36696, 36696, 36696, 37888, 37888, 37888, 39232, 39232, 39232, 39232, 
376, 776, 1160, 1544, 1992, 2344, 2792, 3112, 3624, 4008, 4392, 4776, 5160, 5544, 5992, 6200, 6712, 7224, 7480, 7992, 8248, 8760, 9144, 9528, 9912, 10296, 10680, 11064, 11448, 11832, 12216, 12576, 12960, 13536, 14112, 14112, 14688, 15264, 15264, 15840, 16416, 16416, 16992, 17568, 17568, 18336, 18336, 19080, 19080, 19848, 19848, 20616, 21384, 21384, 22152, 22152, 22920, 22920, 23688, 23688, 24496, 24496, 24496, 25456, 25456, 26416, 26416, 27376, 27376, 27376, 28336, 28336, 29296, 29296, 29296, 30576, 30576, 30576, 31704, 31704, 31704, 32856, 32856, 32856, 34008, 34008, 34008, 35160, 35160, 35160, 36696, 36696, 36696, 37888, 37888, 37888, 37888, 39232, 39232, 39232, 40576, 40576, 40576, 40576, 42368, 42368, 42368, 42368, 43816, 43816, 
408, 840, 1288, 1736, 2152, 2600, 2984, 3496, 3880, 4264, 4776, 5160, 5544, 5992, 6456, 6968, 7224, 7736, 8248, 8504, 9144, 9528, 9912, 10296, 10680, 11064, 11448, 12216, 12576, 12960, 13536, 13536, 14112, 14688, 15264, 15264, 15840, 16416, 16992, 16992, 17568, 18336, 18336, 19080, 19080, 19848, 20616, 20616, 21384, 21384, 22152, 22152, 22920, 22920, 23688, 24496, 24496, 25456, 25456, 25456, 26416, 26416, 27376, 27376, 28336, 28336, 29296, 29296, 29296, 30576, 30576, 30576, 31704, 31704, 32856, 32856, 32856, 34008, 34008, 34008, 35160, 35160, 35160, 36696, 36696, 36696, 37888, 37888, 37888, 39232, 39232, 39232, 40576, 40576, 40576, 40576, 42368, 42368, 42368, 43816, 43816, 43816, 43816, 45352, 45352, 45352, 46888, 46888, 46888, 46888, 
440, 904, 1384, 1864, 2344, 2792, 3240, 3752, 4136, 4584, 5160, 5544, 5992, 6456, 6968, 7480, 7992, 8248, 8760, 9144, 9912, 10296, 10680, 11064, 11448, 12216, 12576, 12960, 13536, 14112, 14688, 14688, 15264, 15840, 16416, 16992, 16992, 17568, 18336, 18336, 19080, 19848, 19848, 20616, 20616, 21384, 22152, 22152, 22920, 22920, 23688, 24496, 24496, 25456, 25456, 26416, 26416, 27376, 27376, 28336, 28336, 29296, 29296, 29296, 30576, 30576, 31704, 31704, 31704, 32856, 32856, 34008, 34008, 34008, 35160, 35160, 35160, 36696, 36696, 36696, 37888, 37888, 39232, 39232, 39232, 40576, 40576, 40576, 42368, 42368, 42368, 42368, 43816, 43816, 43816, 45352, 45352, 45352, 46888, 46888, 46888, 46888, 48936, 48936, 48936, 48936, 48936, 51024, 51024, 51024, 
488, 1000, 1480, 1992, 2472, 2984, 3496, 4008, 4584, 4968, 5544, 5992, 6456, 6968, 7480, 7992, 8504, 9144, 9528, 9912, 10680, 11064, 11448, 12216, 12576, 12960, 13536, 14112, 14688, 15264, 15840, 15840, 16416, 16992, 17568, 18336, 18336, 19080, 19848, 19848, 20616, 21384, 21384, 22152, 22920, 22920, 23688, 24496, 24496, 25456, 25456, 26416, 26416, 27376, 27376, 28336, 28336, 29296, 29296, 30576, 30576, 31704, 31704, 31704, 32856, 32856, 34008, 34008, 35160, 35160, 35160, 36696, 36696, 36696, 37888, 37888, 39232, 39232, 39232, 40576, 40576, 40576, 42368, 42368, 42368, 43816, 43816, 43816, 45352, 45352, 45352, 46888, 46888, 46888, 46888, 48936, 48936, 48936, 48936, 51024, 51024, 51024, 51024, 52752, 52752, 52752, 52752, 55056, 55056, 55056, 
520, 1064, 1608, 2152, 2664, 3240, 3752, 4264, 4776, 5352, 5992, 6456, 6968, 7480, 7992, 8504, 9144, 9528, 10296, 10680, 11448, 11832, 12576, 12960, 13536, 14112, 14688, 15264, 15840, 16416, 16992, 16992, 17568, 18336, 19080, 19080, 19848, 20616, 21384, 21384, 22152, 22920, 22920, 23688, 24496, 24496, 25456, 25456, 26416, 27376, 27376, 28336, 28336, 29296, 29296, 30576, 30576, 31704, 31704, 32856, 32856, 34008, 34008, 34008, 35160, 35160, 36696, 36696, 36696, 37888, 37888, 39232, 39232, 40576, 40576, 40576, 42368, 42368, 42368, 43816, 43816, 43816, 45352, 45352, 45352, 46888, 46888, 46888, 48936, 48936, 48936, 48936, 51024, 51024, 51024, 51024, 52752, 52752, 52752, 55056, 55056, 55056, 55056, 57336, 57336, 57336, 57336, 59256, 59256, 59256, 
552, 1128, 1736, 2280, 2856, 3496, 4008, 4584, 5160, 5736, 6200, 6968, 7480, 7992, 8504, 9144, 9912, 10296, 11064, 11448, 12216, 12576, 12960, 13536, 14112, 14688, 15264, 15840, 16416, 16992, 17568, 18336, 19080, 19848, 19848, 20616, 21384, 22152, 22152, 22920, 23688, 24496, 24496, 25456, 25456, 26416, 27376, 27376, 28336, 28336, 29296, 29296, 30576, 30576, 31704, 31704, 32856, 32856, 34008, 34008, 35160, 35160, 36696, 36696, 37888, 37888, 37888, 39232, 39232, 40576, 40576, 40576, 42368, 42368, 43816, 43816, 43816, 45352, 45352, 45352, 46888, 46888, 46888, 48936, 48936, 48936, 51024, 51024, 51024, 51024, 52752, 52752, 52752, 55056, 55056, 55056, 55056, 57336, 57336, 57336, 57336, 59256, 59256, 59256, 59256, 61664, 61664, 61664, 61664, 63776, 
584, 1192, 1800, 2408, 2984, 3624, 4264, 4968, 5544, 5992, 6712, 7224, 7992, 8504, 9144, 9912, 10296, 11064, 11448, 12216, 12960, 13536, 14112, 14688, 15264, 15840, 16416, 16992, 17568, 18336, 19080, 19848, 19848, 20616, 21384, 22152, 22920, 22920, 23688, 24496, 25456, 25456, 26416, 26416, 27376, 28336, 28336, 29296, 29296, 30576, 31704, 31704, 32856, 32856, 34008, 34008, 35160, 35160, 36696, 36696, 36696, 37888, 37888, 39232, 39232, 40576, 40576, 42368, 42368, 42368, 43816, 43816, 45352, 45352, 45352, 46888, 46888, 46888, 48936, 48936, 48936, 51024, 51024, 51024, 52752, 52752, 52752, 52752, 55056, 55056, 55056, 57336, 57336, 57336, 57336, 59256, 59256, 59256, 61664, 61664, 61664, 61664, 63776, 63776, 63776, 63776, 66592, 66592, 66592, 66592, 
616, 1256, 1864, 2536, 3112, 3752, 4392, 5160, 5736, 6200, 6968, 7480, 8248, 8760, 9528, 10296, 10680, 11448, 12216, 12576, 13536, 14112, 14688, 15264, 15840, 16416, 16992, 17568, 18336, 19080, 19848, 20616, 20616, 21384, 22152, 22920, 23688, 24496, 24496, 25456, 26416, 26416, 27376, 28336, 28336, 29296, 29296, 30576, 31704, 31704, 32856, 32856, 34008, 34008, 35160, 35160, 36696, 36696, 37888, 37888, 39232, 39232, 40576, 40576, 40576, 42368, 42368, 43816, 43816, 43816, 45352, 45352, 46888, 46888, 46888, 48936, 48936, 48936, 51024, 51024, 51024, 52752, 52752, 52752, 55056, 55056, 55056, 55056, 57336, 57336, 57336, 59256, 59256, 59256, 61664, 61664, 61664, 61664, 63776, 63776, 63776, 63776, 66592, 66592, 66592, 66592, 68808, 68808, 68808, 71112, 
712, 1480, 2216, 2984, 3752, 4392, 5160, 5992, 6712, 7480, 8248, 8760, 9528, 10296, 11064, 11832, 12576, 13536, 14112, 14688, 15264, 16416, 16992, 17568, 18336, 19080, 19848, 20616, 21384, 22152, 22920, 23688, 24496, 25456, 25456, 26416, 27376, 28336, 29296, 29296, 30576, 30576, 31704, 32856, 32856, 34008, 35160, 35160, 36696, 36696, 37888, 37888, 39232, 40576, 40576, 40576, 42368, 42368, 43816, 43816, 45352, 45352, 46888, 46888, 48936, 48936, 48936, 51024, 51024, 52752, 52752, 52752, 55056, 55056, 55056, 55056, 57336, 57336, 57336, 59256, 59256, 59256, 61664, 61664, 61664, 63776, 63776, 63776, 66592, 66592, 66592, 68808, 68808, 68808, 71112, 71112, 71112, 73712, 73712, 75376, 75376, 75376, 75376, 75376, 75376, 75376, 75376, 75376, 75376, 75376
};



rlc_entity_general_t g_rlc_entity_nb[MAC_LCID_MAX];
rlc_entity_general_t g_rlc_entity_ue[MAC_LCID_MAX];


void *mac_alloc_buf(u32 size)
{
	return malloc(size);
}

void mac_free_pdu(void *data, void *cookie)
{
	free(cookie);
}


void mac_free_sdu(void *data, void *cookie)
{
	free(data);
}

static u8 *rlc_create_sdu(u16 size, u8 seed)
{
	int i;
	u8 *buf;
	
	buf = (u8 *)malloc(size);
	if(buf)
		for(i=0; i<size; i++)
			buf[i] = seed + i;

	return buf;
}

void macrlc_dump_buffer(u8 *buffer, u16 length)
{
	int i;
	
	for(i=0; i<length; i++)
	{
		if(i%16 == 0)
			printf("\n");
		else if(i%8 == 0)
			printf("-- ");
		printf("%02x ", buffer[i]);
	}
	printf("\n");
}

/* get TBS */
int mac_get_tbs(u32 sdu_size)
{
	u32 mac_tbs = 0;
	int i;
	
	sdu_size = rand() % (sdu_size * 2);
	
	for(i=0; i<27*NB_PRB-1; i++)
	{
		if(mac_tbs_table[i]/8 >= sdu_size)
			break;
	}
	
	mac_tbs = mac_tbs_table[i]/8;
	
	//no less than min TBS size: mac header(1 byte) + rlc header (2 bytes) + rlc payload (>= 1 byte)
	if(mac_tbs < MAC_TBS_MIN_SIZE)
		mac_tbs = MAC_TBS_MIN_SIZE;
	
	return mac_tbs;
}

/* build MAC pdu: 
 * only one rlc_entity considered
 * no other control elements except padding control element */
#define RESERVE_SPACE 100
int mac_build_pdu(u32 lc_id, u8 **mac_pdu, u32 *mac_pdu_size, u8 **buf, u32 *pdu_type)
{
	rlc_entity_um_t *rlc_um;
	rlc_entity_um_tx_t *rlc_umtx = NULL;
	rlc_entity_am_t *rlc_am;
	rlc_entity_am_tx_t *rlc_amtx = NULL;
	u8 *pdu, *cookie;
	mac_pdu_subhead_t *mac_subhead = NULL;
	u32 headsize, offset = 0;
	u32 padding = 0;
	
	u32 final_rlc_pdu_size = 0, rlc_pdu_size = 0, mac_tbs;
	rlc_entity_common_head_t *rlc_entity;

	*mac_pdu_size = 0;
	
	assert(lc_id < MAC_LCID_MAX);
	rlc_entity = (rlc_entity_common_head_t *)&g_rlc_entity_nb[lc_id];
	
	if(rlc_entity->type == RLC_ENTITY_TYPE_UM)
	{
		rlc_um = (rlc_entity_um_t *)rlc_entity;
		rlc_umtx = &(rlc_um->umtx);
		
		/* get all RLC sdu size in RLC SDU queue */
		rlc_pdu_size = rlc_um_tx_estimate_pdu_size(rlc_umtx);
	}
	else if(rlc_entity->type == RLC_ENTITY_TYPE_AM)
	{
		rlc_am = (rlc_entity_am_t *)rlc_entity;
		rlc_amtx = &(rlc_am->amtx);
		
		/* get all RLC sdu size in RLC SDU queue */
		rlc_pdu_size = rlc_am_tx_estimate_pdu_size(rlc_amtx, NULL);
	}
	else
		return 0;
		
	if(rlc_pdu_size == 0)
		return 0;
		
	/* get TBS: TBS is determinated by MAC UL or DL scheduler respectively */
	mac_tbs = mac_get_tbs(rlc_pdu_size);
	if(mac_tbs < 3)		/* at least: a subhead + a rlc status pdu */
		return 0;
	
	/* truncate rlc_pdu_size */
	if(rlc_pdu_size >= mac_tbs - 1)
		rlc_pdu_size = mac_tbs - 1;
		
	/* get buffer: reserve space (100 bytes) is reserved for mac subhead, control element, etc. */
	cookie = (u8 *)mac_alloc_buf(mac_tbs+RESERVE_SPACE);
	assert(cookie);
	
	/* To avoid copying RLC PDU to MAC buffer, we firstly build RLC PDU,
	   because the real built size may less than the estimated rlc_pdu_size, 
	   even that is quite less possible.
	 */
	if(rlc_entity->type == RLC_ENTITY_TYPE_UM)
	{
		final_rlc_pdu_size = rlc_um_tx_build_pdu(rlc_umtx, cookie+RESERVE_SPACE, rlc_pdu_size);
		if(final_rlc_pdu_size == 0)
		{
			free(cookie);
			return 0;
		}
	}
	else if(rlc_entity->type == RLC_ENTITY_TYPE_AM)
	{
		final_rlc_pdu_size = rlc_am_tx_build_pdu(rlc_amtx, cookie+RESERVE_SPACE, rlc_pdu_size, cookie, pdu_type);
		if(final_rlc_pdu_size == 0)
		{
			free(cookie);
			return 0;
		}
	}
	
	rlc_pdu_size = final_rlc_pdu_size;
	
	/* has padding? */
	if(rlc_pdu_size < mac_tbs - 1)
	{
		if(rlc_pdu_size + 1 >= mac_tbs - 2)
		{
			padding = 1;	/* padding before */
			headsize = mac_tbs - rlc_pdu_size;
		}
		else
		{
			padding = 2;	/* padding after */
			headsize = 3 + (rlc_pdu_size>=128);
		}
	}
	else
		headsize = 1;
	
	/* now fix the start point of MAC PDU */
	assert(headsize < RESERVE_SPACE);
	pdu = cookie+RESERVE_SPACE-headsize;
	
	/* padding before */
	if(padding == 1)
	{
		while(rlc_pdu_size + 1 + offset < mac_tbs)
		{
			mac_subhead = (mac_pdu_subhead_t *)(pdu + offset);
			mac_subhead->r = 0;
			mac_subhead->e = 0;
			mac_subhead->lc_id = MAC_UL_LCID_PADDING;
			offset ++;
		}
	}
	
	/* build normal subhead */
	mac_subhead = (mac_pdu_subhead_t *)(pdu + offset);
	mac_subhead->r = 0;
	mac_subhead->e = (padding == 2);
	mac_subhead->lc_id = lc_id;
	if(mac_subhead->e)
	{
		if(rlc_pdu_size < 128)
		{
			*(pdu + offset + 1) = rlc_pdu_size;
			offset += 2;
		}
		else
		{
			mac_subhead->f = 1;
			mac_subhead->l = rlc_pdu_size;
			offset += 3;
		}
	}
	else
		offset ++;		//no padding 
	
	/* padding after */
	if(padding == 2)
	{
		mac_subhead = (mac_pdu_subhead_t *)(pdu + offset);
		mac_subhead->r = 0;
		mac_subhead->e = 0;
		mac_subhead->lc_id = MAC_UL_LCID_PADDING;
		offset ++;
	}
	
	*mac_pdu = pdu;
	*mac_pdu_size = mac_tbs;
	*buf = cookie;
	
	return 1;
}

/* process MAC PDU (UE side) */
int mac_process_pdu(u8 *mac_pdu, u32 pdu_len)
{
	u32 lc_id;
	u32 i, l = 0;
	u32 ret = 0;
	u32 n_sdu = 0;
	int left_len = pdu_len;
	u8 *mac_sdu = NULL;
	mac_pdu_subhead_t *subhead_ptr = (mac_pdu_subhead_t *)mac_pdu;
	mac_pdu_subhead_t subhead[32];

	/* parse subhead */
	while(left_len > 0)
	{
		if(subhead_ptr->e == 0)
		{
			subhead[n_sdu].lc_id = subhead_ptr->lc_id;
			subhead[n_sdu].l = left_len-1;
			mac_sdu = (u8 *)subhead_ptr + 1;			//this first SDU pointer
			n_sdu ++;
			left_len = 0;
			break;
		}
		else
		{
			int head_len = 1;
			subhead[n_sdu].lc_id = subhead_ptr->lc_id;
			switch(subhead_ptr->lc_id)
			{
				case MAC_DL_LCID_UCRI:
					subhead[n_sdu].l = 6;
					break;
				case MAC_DL_LCID_TA:
					subhead[n_sdu].l = 1;
					break;
				case MAC_DL_LCID_DRX:
				case MAC_DL_LCID_PADDING:
					subhead[n_sdu].l = 0;
					break;
				default:
					if(subhead_ptr->f)
					{
						head_len = 3;
						subhead[n_sdu].l = subhead_ptr->l;
					}
					else
					{
						head_len = 2;
						subhead[n_sdu].l = (subhead_ptr->l >> 8);
					}
					break;
			}
			left_len -= head_len + subhead[n_sdu].l;
			subhead_ptr = (mac_pdu_subhead_t *)((u8 *)subhead_ptr + head_len);
			n_sdu ++;
		}
	}
	
	if(mac_sdu == NULL || n_sdu == 0 || left_len != 0)
	{
		ZLOG_ERR("mac_sdu=0x%p n_sdu=%u left_len=%d.\n", mac_sdu, n_sdu, left_len);
		return -1;
	}
	
	for(i=0; i<n_sdu; i++)
	{
		lc_id = subhead[i].lc_id;
		l = subhead[i].l;
		
		//dump MAC sub-header
		ZLOG_DEBUG("Rx MAC PDU sub-header: LCID=%u L=%u.\n", lc_id, l);
				
		/* process special LCID */
		switch(lc_id)
		{
			case MAC_DL_LCID_CCCH:
			case MAC_DL_LCID_UCRI:
			case MAC_DL_LCID_TA:
			case MAC_DL_LCID_DRX:
			case MAC_DL_LCID_PADDING:
				break;
				
			default:		//Identity of the logical channel
			{
				assert(l > 0);
				assert(lc_id < MAC_LCID_MAX);
								
				rlc_entity_common_head_t *rlc_entity = (rlc_entity_common_head_t *)&(g_rlc_entity_ue[lc_id]);

				/* process RLC PDU */
				if(rlc_entity->type == RLC_ENTITY_TYPE_UM)
				{
					rlc_entity_um_t *rlc_entity_um = (rlc_entity_um_t *)rlc_entity;
											
					if(rlc_um_rx_process_pdu(&rlc_entity_um->umrx, mac_sdu, l, mac_pdu) != 0)
					{
						ZLOG_WARN("rlc_um_rx_process_pdu() failure.\n");
					}
				}
				else if(rlc_entity->type == RLC_ENTITY_TYPE_AM)
				{
					rlc_entity_am_t *rlc_entity_am = (rlc_entity_am_t *)rlc_entity;
					
					if(rlc_am_rx_process_pdu(&rlc_entity_am->amrx, mac_sdu, l, mac_pdu) != 0)
					{
						ZLOG_WARN("rlc_am_rx_process_pdu() failure.\n");
					}
				}
				else
					ZLOG_WARN("unknown RLC type: %d\n", rlc_entity->type);

				break;
			}
		}
		
		//to next SDU
		mac_sdu += l;
	}
	
	return ret;
}

u8 *copy_pdu_to_rx(u8 *pdu_src, u32 len)
{
	u8 *pdu_dst;

	pdu_dst = mac_alloc_buf(len);
	memcpy(pdu_dst, pdu_src, len);

	return pdu_dst;
}

int main(int argc, char *argv[])
{
	u32 tti, n_tti = 10;
	u32 i;
	u32 pdu_type;
	u32 sdu_size;
	u32 mac_pdu_size;
	u8 *sdu_ptr, *buffer, *mac_pdu, *new_mac_pdu;
	
	zlog_default = openzlog (ZLOG_STDOUT);

	/* global init */
	rlc_init();
	
	/********************************************************************
	 * 1)UM example 
	 ********************************************************************/
	rlc_entity_um_tx_t *rlc_umtx;
	
	/* init rlc entity */
	rlc_um_init(&(g_rlc_entity_nb[1].rlc_um), 10/*sn_bits*/, 512/*UM_Window_Size*/, 5/*t_Reordering*/,
			mac_free_pdu, mac_free_sdu);

	rlc_um_init(&(g_rlc_entity_ue[1].rlc_um), 10/*sn_bits*/, 512/*UM_Window_Size*/, 5/*t_Reordering*/,
			mac_free_pdu, mac_free_sdu);
	
	/* more: 
	   User can call rlc_um_set_deliv_func() here, so user can process sdu later.
	   User can also set logical channal ID and private data in RLC entity here.
	 */

	rlc_umtx = &(g_rlc_entity_nb[1].rlc_um.umtx);
	
	for(tti=0; tti < n_tti; tti++)
	{
		ZLOG_DEBUG("TTI=%d *************************************\n", tti);
		
		rlc_timer_push(1 /* 1 ms */);
		
		/* rlc sdu enqueue */
		for(i=0; i<3; i++)
		{
			sdu_size = (rand() % 400) + 1;
			sdu_ptr = rlc_create_sdu(sdu_size, 1);
			rlc_um_tx_sdu_enqueue(rlc_umtx, sdu_ptr, sdu_size, NULL);
		}
		
		/* build MAC pdu */
		/* u32 lc_id, u8 **mac_pdu, u32 *mac_pdu_size, u8 **buf, u32 *pdu_type */
		if(mac_build_pdu(1, &mac_pdu, &mac_pdu_size, &buffer, NULL) == 0)
		{
			ZLOG_ERR("failed to build MAC PDU\n");
			continue;
		}
		
		/* dump and duplicate pdu */
		ZLOG_DEBUG("Rx PDU length=%u.\n", mac_pdu_size);
		macrlc_dump_buffer(mac_pdu, mac_pdu_size);

		/* more: user can drop some pdu here and so that to trigger t_Reordering */

		new_mac_pdu = malloc(mac_pdu_size);
		assert(new_mac_pdu);
		memcpy(new_mac_pdu, mac_pdu, mac_pdu_size);
		/* It is up to user to free for RLC UM */
		free(buffer);
		
		/* process pdu */
		mac_process_pdu(new_mac_pdu, mac_pdu_size);
	}
	
	/********************************************************************
	 * 2)AM example 
	 ********************************************************************/
	rlc_entity_am_tx_t *rlc_amtx;
	
	/* init rlc entity */
	rlc_am_init(&(g_rlc_entity_nb[3].rlc_am), 
					3 /*t_Reordering*/, 
					4 /* t_StatusPdu */,
					3 /*t_StatusProhibit*/, 
					6 /*t_PollRetransmit*/, 
					12 /*maxRetxThreshold*/,
					10 /*pollPDU*/,
					1000 /*pollByte*/,
					mac_free_pdu /*void (*free_pdu)(void *, void *)*/,	
					mac_free_sdu /*void (*free_sdu)(void *, void *)*/);
	
	rlc_am_init(&(g_rlc_entity_ue[3].rlc_am), 
					3 /*t_Reordering*/, 
					4 /* t_StatusPdu */,
					3 /*t_StatusProhibit*/, 
					6 /*t_PollRetransmit*/, 
					12 /*maxRetxThreshold*/,
					10 /*pollPDU*/,
					1000 /*pollByte*/,
					mac_free_pdu /*void (*free_pdu)(void *, void *)*/,
					mac_free_sdu /*void (*free_sdu)(void *, void *)*/);

	/* more: user can call rlc_am_set_deliv_func() here, so user can process sdu later */

	rlc_amtx = &(g_rlc_entity_nb[3].rlc_am.amtx);
	for(tti=0; tti < n_tti; tti++)
	{
		ZLOG_DEBUG("TTI=%d *************************************\n", tti);
		
		rlc_timer_push(1 /* 1 ms */);
		
		/* rlc sdu enqueue */
		for(i=0; i<3; i++)
		{
			sdu_size = (rand() % 400) + 1;
			sdu_ptr = rlc_create_sdu(sdu_size, 1);
			rlc_am_tx_sdu_enqueue(rlc_amtx, sdu_ptr, sdu_size, NULL);
		}
		
		/* build MAC pdu */
		/* u32 lc_id, u8 **mac_pdu, u32 *mac_pdu_size, u8 **buf, u32 *pdu_type */
		if(mac_build_pdu(3, &mac_pdu, &mac_pdu_size, &buffer, &pdu_type) == 0)
		{
			ZLOG_ERR("failed to build MAC PDU\n");
			continue;
		}
		
		/* dump and duplicate pdu */
		ZLOG_DEBUG("Rx PDU length=%u.\n", mac_pdu_size);
		macrlc_dump_buffer(mac_pdu, mac_pdu_size);

		/* more: user can drop some MAC pdu here and will trigger t_Reordering, status PDU, RLC resegmentation, etc. */

		new_mac_pdu = malloc(mac_pdu_size);
		assert(new_mac_pdu);
		memcpy(new_mac_pdu, mac_pdu, mac_pdu_size);
		/* It is up to user to free status/ReTx PDU for RLC AM */
		if(pdu_type != RLC_AM_FRESH_PDU)
			free(mac_pdu);
		
		/* process pdu */
		mac_process_pdu(new_mac_pdu, mac_pdu_size);
		
		/* more: if any status PDU, user can call mac_build_pdu and send it to ENODEB side entity */
	}
	
	/********************************************************************
	 * 3)AM example that triggers status PDU (not with MAC)
	 ********************************************************************/
	int ret;
	n_tti = 100;
	u16 tbs;
	u8 *pdu;
	u16 pdu_len;
	u32 status_pdu_size;
	
	rlc_entity_am_tx_t *nbrlc_amtx, *uerlc_amtx;
	rlc_entity_am_rx_t *nbrlc_amrx, *uerlc_amrx;
	nbrlc_amtx = &(g_rlc_entity_nb[3].rlc_am.amtx);
	uerlc_amtx = &(g_rlc_entity_ue[3].rlc_am.amtx);
	nbrlc_amrx = &(g_rlc_entity_nb[3].rlc_am.amrx);
	uerlc_amrx = &(g_rlc_entity_ue[3].rlc_am.amrx);
	
	for(tti=0; tti < n_tti; tti++)
	{
		ZLOG_DEBUG("TTI=%d*************************************\n", tti);
		
		rlc_timer_push(1 /* 1 ms */);
		
		/* rlc sdu enqueue */
		for(i=0; i<3; i++)
		{
			sdu_size = (rand() % 400) + 1;
			sdu_ptr = rlc_create_sdu(sdu_size, 1);
			rlc_am_tx_sdu_enqueue(nbrlc_amtx, sdu_ptr, sdu_size, NULL);
		}
		
		/* get all RLC sdu size in RLC SDU queue */
		sdu_size = rlc_am_tx_estimate_pdu_size(nbrlc_amtx, NULL);
		if(sdu_size == 0)
			continue;
		
		/* get TBS */
		tbs = rand() % 800;
		tbs = RLC_MAX(tbs, 3);
		tbs = RLC_MIN(tbs, sdu_size);

		/* build RLC PDU */
		pdu = mac_alloc_buf(tbs);
		pdu_len = rlc_am_tx_build_pdu(nbrlc_amtx, pdu, tbs, pdu, &pdu_type);
		
		if(pdu_len)
		{
			macrlc_dump_buffer(pdu, pdu_len);
	
			/* chance to drop pdu */
			if((rand()%100) < 10)
			{
				rlc_am_pdu_head_t *pdu_hdr;
				
				pdu_hdr = (rlc_am_pdu_head_t *)pdu;
				ZLOG_INFO("pdu is dropped, sn=%u size=%u\n", pdu_hdr->sn, pdu_len);
				if(pdu_type != RLC_AM_FRESH_PDU)
					mac_free_pdu(pdu, pdu);
				continue;
			}
			
			/* process pdu */
			if(pdu_type == RLC_AM_FRESH_PDU)
				pdu = copy_pdu_to_rx(pdu, pdu_len);
			if(rlc_am_rx_process_pdu(uerlc_amrx, pdu, pdu_len, pdu) != 0)
			{
				ZLOG_WARN("rlc_am_rx_process_pdu() failure.\n");
			}

			/* any status pdu? */
			status_pdu_size = rlc_am_tx_get_status_pdu_size(uerlc_amtx);
			if(status_pdu_size)
			{
				tbs = status_pdu_size;
				pdu = (u8 *)mac_alloc_buf(tbs);
				pdu_len = rlc_am_tx_build_pdu(uerlc_amtx, pdu, tbs, pdu, &pdu_type);
				assert(pdu_len);

				macrlc_dump_buffer(pdu, pdu_len);

				if(pdu_type == RLC_AM_FRESH_PDU)
					pdu = copy_pdu_to_rx(pdu, pdu_len);
				ret = rlc_am_rx_process_pdu(nbrlc_amrx, pdu, pdu_len, pdu);
				assert(ret == 0);
			}
		}
		else
		{
			ZLOG_WARN("failed to build PDU with size=%d\n", tbs);
		}
	}

	return 0;
}


